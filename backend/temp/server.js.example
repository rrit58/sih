// Example: Updated backend/server.js with OTP Authentication Routes
// This shows exactly how to add the auth routes to your existing server.js

require('dotenv').config()

const express = require('express')
const cors = require('cors')
const bodyParser = require('body-parser')
const { Configuration, OpenAIApi } = require('openai')

// ADD THIS IMPORT ↓
const authRoutes = require('./auth.routes')
// ADD THIS IMPORT ↑

const app = express()
const PORT = process.env.PORT || 4000

app.use(cors())
app.use(bodyParser.json())

// ADD THIS LINE ↓
app.use('/api/auth', authRoutes)
// ADD THIS LINE ↑

const OPENAI_KEY = process.env.OPENAI_API_KEY
if (!OPENAI_KEY) {
	console.warn('Warning: OPENAI_API_KEY is not set. Please set it in backend/.env')
}

const configuration = new Configuration({ apiKey: OPENAI_KEY })
const openai = new OpenAIApi(configuration)

// Existing endpoints
app.get('/api/ping', (req, res) => res.json({ ok: true }))

app.post('/api/chat', async (req, res) => {
	const { message, lang } = req.body || {}
	if (!message || typeof message !== 'string') return res.status(400).json({ error: 'Missing `message` in body' })

	try {
		const systemPrompt = `You are DBT Connect assistant. Answer concisely and helpfully. If the user asks for local app instructions (upload, login, roles), provide clear step-by-step guidance.`

		const messages = [
			{ role: 'system', content: systemPrompt },
			{ role: 'user', content: message }
		]

		const resp = await openai.createChatCompletion({
			model: process.env.OPENAI_MODEL || 'gpt-3.5-turbo',
			messages,
			max_tokens: 700,
			temperature: 0.2
		})

		const reply = resp?.data?.choices?.[0]?.message?.content || 'Sorry, I could not generate a response.'
		return res.json({ reply })
	} catch (err) {
		console.error('OpenAI error:', err?.response?.data || err.message || err)
		return res.status(500).json({ error: 'OpenAI request failed' })
	}
})

app.listen(PORT, () => {
	console.log(`Backend server listening on http://localhost:${PORT}`)
})
